# 动态表单实现总结

## 项目结构

```
dynamic-form-core/
├── types.ts              # 类型定义
├── schema-utils.ts       # Schema 工具函数
├── FormItem.tsx          # 表单项组件
├── DynamicForm.tsx       # 主表单组件
├── index.ts              # 导出入口
├── README.md             # 使用文档
└── example.tsx           # 使用示例
```

## 核心文件说明

### 1. types.ts
定义了所有的类型接口：
- `FieldType`: 支持的表单控件类型
- `FieldOption`: 选择类控件的选项配置
- `FieldSchema`: 单个表单字段的配置
- `FormSchema`: 完整表单的配置
- `DynamicFormProps`: 组件属性
- `DynamicFormRef`: 实例方法接口

### 2. schema-utils.ts
提供 Schema 处理的工具函数：
- `extractDefaultValues`: 从字段配置中提取默认值
- `getDisplayLabel`: 获取只读模式下的显示标签
- `isValidFieldName`: 验证字段名是否存在
- `pickValues`: 过滤指定字段的值
- `generateJsonSchema`: 生成 JSON Schema 用于 AI 集成

### 3. FormItem.tsx
表单项包装组件，负责：
- 根据字段类型渲染对应的控件
- 处理只读模式的展示
- 统一的布局结构（使用 Field 组件）
- 错误提示和描述文本的显示

支持的控件类型：
- input: 单行文本输入
- textarea: 多行文本输入
- select: 下拉选择
- radio: 单选按钮组
- checkbox: 复选框
- switch: 开关
- slider: 滑块
- number: 数字输入

### 4. DynamicForm.tsx
主表单组件，核心功能：
- 基于 react-hook-form 的表单管理
- 支持 Zod 验证
- 实现了完整的实例方法（通过 ref 暴露）
- 表单值变化监听
- 只读模式支持
- 预置的提交和重置按钮

实例方法：
- `getFieldsError`: 获取字段错误信息
- `getFieldsValue`: 获取字段值
- `validateFields`: 触发验证
- `setFields`: 设置字段状态
- `resetFields`: 重置字段
- `submit`: 提交表单
- `getForm`: 获取原始 form 实例

## 技术栈

- **React**: UI 框架
- **react-hook-form**: 表单状态管理
- **@hookform/resolvers**: 验证器集成
- **zod**: Schema 验证
- **TypeScript**: 类型安全
- **Tailwind CSS**: 样式（通过 shadcn/ui 组件）

## 设计亮点

### 1. 表单组件的注册机制
采用 **基于已有素材封装** 的方案：
- 直接使用 shadcn/ui 的基础组件
- FormItem 统一包裹，提供一致的布局和交互
- 不需要额外的注册机制，代码更简洁

### 2. 只读模式的实现
- 不是简单的 disabled，而是真正的"展示模式"
- select/radio 显示 label 而不是 value
- checkbox/switch 显示"是/否"而不是 true/false
- 保持良好的可读性

### 3. 实例方法设计
参考 Ant Design Form 的 API 设计：
- 通过 `useImperativeHandle` 暴露方法
- 方法命名和参数与 Ant Design 保持一致
- 提供了 `getForm()` 用于高级场景

### 4. Schema 驱动
- 支持 JSON 配置动态生成表单
- 与 AI 对话场景完美集成
- 提供 `generateJsonSchema` 辅助 AI 理解表单结构

### 5. 灵活的扩展性
- 字段级别的自定义渲染函数
- 支持自定义验证 Schema
- 可以轻松添加新的控件类型

## AI 集成场景

### 使用流程

1. **AI 生成 Schema**
   ```json
   {
     "title": "用户反馈",
     "fields": [
       {"name": "rating", "label": "评分", "type": "slider", "range": {"min": 1, "max": 5}},
       {"name": "comment", "label": "意见", "type": "textarea"}
     ]
   }
   ```

2. **前端渲染表单**
   ```tsx
   <DynamicForm schema={aiGeneratedSchema} onFinish={sendToAI} />
   ```

3. **用户填写并提交**
   ```json
   {
     "rating": 4,
     "comment": "很好用，但还可以改进..."
   }
   ```

4. **AI 接收并处理用户反馈**

### 辅助 AI 理解的工具

使用 `generateJsonSchema` 可以生成标准的 JSON Schema，方便 AI 理解表单结构：

```tsx
const jsonSchema = generateJsonSchema(schema.fields);
// 将 jsonSchema 发送给 AI
```

## 使用示例

详细使用示例请参考：
- `README.md`: 完整的使用文档
- `example.tsx`: 实际运行的示例代码

## 后续优化方向

1. ✅ 基础控件支持完整
2. ⏳ Date picker 控件集成
3. ⏳ 文件上传控件
4. ⏳ 条件显示（字段联动）
5. ⏳ 分步表单支持
6. ⏳ 表单布局配置（栅格系统）
7. ⏳ 国际化支持
8. ⏳ 主题定制

## 注意事项

1. 确保安装了所需的依赖包
2. 字段的 `name` 必须唯一
3. 使用 `validateSchema` 时，字段名要匹配
4. 只读模式下不会进行表单验证
5. 选择类字段必须提供 `options` 配置
