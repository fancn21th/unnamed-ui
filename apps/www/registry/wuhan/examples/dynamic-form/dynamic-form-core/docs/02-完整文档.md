# DynamicForm 动态表单组件

## 简介

`DynamicForm` 是一个基于 Schema 配置的动态表单解决方案，底层使用 `react-hook-form` 实现表单状态管理和验证。适用于需要根据配置动态生成表单的场景，特别是 AI 对话场景中的用户交互表单。

## 特性

- ✅ **Schema 驱动**: 通过 JSON Schema 配置动态生成表单
- ✅ **类型安全**: 完整的 TypeScript 类型定义
- ✅ **表单验证**: 基于 Zod 的强大验证能力
- ✅ **只读模式**: 支持表单的只读展示模式
- ✅ **丰富的控件**: 支持 input、textarea、select、radio、checkbox、switch、slider、number 等多种控件
- ✅ **实例方法**: 提供类似 Ant Design Form 的实例方法，通过 ref 访问
- ✅ **灵活布局**: 支持垂直、水平、响应式三种布局方向
- ✅ **自定义渲染**: 支持字段级别的自定义渲染函数

## 安装依赖

```bash
pnpm install react-hook-form @hookform/resolvers zod
```

## 基础用法

### 简单示例

```tsx
import { useRef } from "react";
import { DynamicForm, type DynamicFormRef, type FormSchema } from "./dynamic-form-core";

function App() {
  const formRef = useRef<DynamicFormRef>(null);

  const schema: FormSchema = {
    title: "用户信息表单",
    description: "请填写您的基本信息",
    fields: [
      {
        name: "username",
        label: "用户名",
        type: "input",
        placeholder: "请输入用户名",
        required: true,
      },
      {
        name: "email",
        label: "邮箱",
        type: "input",
        placeholder: "请输入邮箱地址",
      },
      {
        name: "bio",
        label: "个人简介",
        type: "textarea",
        placeholder: "介绍一下自己...",
      },
    ],
  };

  return (
    <DynamicForm
      ref={formRef}
      schema={schema}
      onFinish={(values) => {
        console.log("表单提交:", values);
      }}
    />
  );
}
```

### 带验证的表单

```tsx
import * as z from "zod";
import { DynamicForm, type FormSchema } from "./dynamic-form-core";

const schema: FormSchema = {
  title: "Bug 反馈表单",
  fields: [
    {
      name: "title",
      label: "Bug 标题",
      type: "input",
      placeholder: "简要描述问题",
      required: true,
    },
    {
      name: "description",
      label: "详细描述",
      type: "textarea",
      placeholder: "请详细描述问题...",
      required: true,
    },
    {
      name: "priority",
      label: "优先级",
      type: "select",
      options: [
        { value: "low", label: "低" },
        { value: "medium", label: "中" },
        { value: "high", label: "高" },
      ],
      defaultValue: "medium",
    },
  ],
};

const validateSchema = z.object({
  title: z
    .string()
    .min(5, "Bug 标题至少 5 个字符")
    .max(50, "Bug 标题最多 50 个字符"),
  description: z
    .string()
    .min(20, "描述至少 20 个字符")
    .max(500, "描述最多 500 个字符"),
  priority: z.enum(["low", "medium", "high"]),
});

function BugReport() {
  return (
    <DynamicForm
      schema={schema}
      validateSchema={validateSchema}
      onFinish={(values) => {
        console.log("提交 Bug:", values);
      }}
      onFinishFailed={({ errors }) => {
        console.error("验证失败:", errors);
      }}
    />
  );
}
```

### 使用实例方法

```tsx
import { useRef } from "react";
import { DynamicForm, type DynamicFormRef } from "./dynamic-form-core";

function FormWithMethods() {
  const formRef = useRef<DynamicFormRef>(null);

  const handleGetValues = () => {
    const values = formRef.current?.getFieldsValue();
    console.log("当前表单值:", values);
  };

  const handleValidate = async () => {
    try {
      const values = await formRef.current?.validateFields();
      console.log("验证通过:", values);
    } catch (error) {
      console.error("验证失败:", error);
    }
  };

  const handleSetFields = () => {
    formRef.current?.setFields([
      { name: "username", value: "张三" },
      { name: "email", value: "zhangsan@example.com" },
    ]);
  };

  const handleReset = () => {
    formRef.current?.resetFields();
  };

  const handleSubmit = async () => {
    await formRef.current?.submit();
  };

  return (
    <div>
      <DynamicForm
        ref={formRef}
        schema={schema}
        showActions={false} // 隐藏默认按钮
        onFinish={(values) => console.log(values)}
      />
      
      <div className="mt-4 flex gap-2">
        <button onClick={handleGetValues}>获取值</button>
        <button onClick={handleValidate}>验证</button>
        <button onClick={handleSetFields}>设置值</button>
        <button onClick={handleReset}>重置</button>
        <button onClick={handleSubmit}>提交</button>
      </div>
    </div>
  );
}
```

### 只读模式

```tsx
<DynamicForm
  schema={schema}
  initialValues={{
    username: "张三",
    email: "zhangsan@example.com",
    status: "active",
  }}
  readonly={true}
  showActions={false}
/>
```

在只读模式下：
- 所有表单控件不可编辑
- 选择类控件（select、radio）会显示对应的 label 而不是 value
- checkbox 和 switch 会显示"是"或"否"

## API

### DynamicForm Props

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| schema | `FormSchema` | - | 表单配置 Schema（必填） |
| className | `string` | - | 自定义样式类名 |
| style | `React.CSSProperties` | - | 内联样式 |
| initialValues | `Record<string, any>` | `{}` | 表单初始值 |
| onValuesChange | `(values) => void` | - | 表单值变化回调 |
| onFinish | `(values) => void` | - | 表单提交成功回调 |
| onFinishFailed | `(errorInfo) => void` | - | 表单提交失败回调 |
| validateSchema | `z.ZodType<any>` | - | Zod 验证 Schema |
| readonly | `boolean` | `false` | 是否只读模式 |
| showActions | `boolean` | `true` | 是否显示操作按钮 |
| submitText | `string` | `"提交"` | 提交按钮文本 |
| resetText | `string` | `"重置"` | 重置按钮文本 |
| showTitle | `boolean` | `true` | 是否显示表单标题 |

### DynamicFormRef 方法

通过 `ref` 可以访问以下实例方法：

#### getFieldsError

获取字段错误信息。

```tsx
getFieldsError(nameList?: string[]): Array<{ name: string; errors: string[] }>
```

**示例:**
```tsx
// 获取所有字段错误
const errors = formRef.current?.getFieldsError();

// 获取指定字段错误
const errors = formRef.current?.getFieldsError(["username", "email"]);
```

#### getFieldsValue

获取字段值。

```tsx
getFieldsValue(nameList?: string[]): Record<string, any>
```

**示例:**
```tsx
// 获取所有字段值
const values = formRef.current?.getFieldsValue();

// 获取指定字段值
const values = formRef.current?.getFieldsValue(["username", "email"]);
```

#### validateFields

触发表单验证。

```tsx
validateFields(nameList?: string[]): Promise<Record<string, any>>
```

**示例:**
```tsx
// 验证所有字段
try {
  const values = await formRef.current?.validateFields();
  console.log("验证通过:", values);
} catch (error) {
  console.error("验证失败");
}

// 验证指定字段
await formRef.current?.validateFields(["username", "email"]);
```

#### setFields

设置字段状态（值和错误）。

```tsx
setFields(fields: Array<{ name: string; value?: any; errors?: string[] }>): void
```

**示例:**
```tsx
formRef.current?.setFields([
  { name: "username", value: "张三" },
  { name: "email", errors: ["邮箱格式不正确"] },
]);
```

#### resetFields

重置字段到初始值。

```tsx
resetFields(nameList?: string[]): void
```

**示例:**
```tsx
// 重置所有字段
formRef.current?.resetFields();

// 重置指定字段
formRef.current?.resetFields(["username", "email"]);
```

#### submit

提交表单。

```tsx
submit(): Promise<void>
```

**示例:**
```tsx
await formRef.current?.submit();
```

#### getForm

获取 react-hook-form 的表单实例（高级用法）。

```tsx
getForm(): UseFormReturn<any>
```

### FormSchema

表单配置 Schema 的结构定义：

```tsx
interface FormSchema {
  title?: string;        // 表单标题
  description?: string;  // 表单描述
  fields: FieldSchema[]; // 字段配置列表
}
```

### FieldSchema

字段配置的结构定义：

```tsx
interface FieldSchema {
  name: string;                    // 字段名（必填）
  label: string;                   // 字段标签（必填）
  type: FieldType;                 // 字段类型（必填）
  description?: string;            // 字段描述
  placeholder?: string;            // 占位符
  defaultValue?: any;              // 默认值
  required?: boolean;              // 是否必填
  disabled?: boolean;              // 是否禁用
  options?: FieldOption[];         // 选项列表（用于 select、radio 等）
  orientation?: "vertical" | "horizontal" | "responsive"; // 布局方向
  min?: number;                    // 最小值（用于 number）
  max?: number;                    // 最大值（用于 number）
  step?: number;                   // 步进值（用于 number）
  range?: {                        // 范围配置（用于 slider）
    min: number;
    max: number;
    step?: number;
  };
  render?: (props) => ReactNode;   // 自定义渲染函数
}
```

### FieldType

支持的字段类型：

- `input` - 单行文本输入
- `textarea` - 多行文本输入
- `select` - 下拉选择
- `radio` - 单选按钮组
- `checkbox` - 复选框
- `switch` - 开关
- `slider` - 滑块
- `number` - 数字输入
- `date` - 日期选择（待实现）

## 高级用法

### 自定义字段渲染

```tsx
const schema: FormSchema = {
  fields: [
    {
      name: "customField",
      label: "自定义字段",
      type: "input",
      render: ({ value, onChange, error }) => (
        <div>
          <input
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="custom-input"
          />
          {error && <span className="error">{error.message}</span>}
        </div>
      ),
    },
  ],
};
```

### 动态表单（AI 场景）

在 AI 对话场景中，可以根据 AI 返回的配置动态生成表单：

```tsx
function AIFormDialog({ aiResponse }) {
  // AI 返回的 Schema 配置
  const schema = useMemo(() => {
    return {
      title: aiResponse.formTitle,
      description: aiResponse.formDescription,
      fields: aiResponse.fields.map(field => ({
        name: field.id,
        label: field.label,
        type: field.inputType,
        required: field.isRequired,
        options: field.choices?.map(choice => ({
          value: choice.value,
          label: choice.display
        }))
      }))
    };
  }, [aiResponse]);

  return (
    <DynamicForm
      schema={schema}
      onFinish={(values) => {
        // 将用户填写的数据发送回 AI
        sendToAI(values);
      }}
    />
  );
}
```

### 字段联动

使用 `onValuesChange` 实现字段联动：

```tsx
function LinkedForm() {
  const [schema, setSchema] = useState<FormSchema>(initialSchema);

  const handleValuesChange = (values: Record<string, any>) => {
    // 根据某个字段的值动态修改其他字段
    if (values.country === "china") {
      setSchema({
        ...schema,
        fields: schema.fields.map(field => 
          field.name === "province" 
            ? { ...field, options: chinaProvinces }
            : field
        )
      });
    }
  };

  return (
    <DynamicForm
      schema={schema}
      onValuesChange={handleValuesChange}
    />
  );
}
```

## AI 消息输出规范

为了让 AI 能够生成符合规范的表单配置，可以使用 `generateJsonSchema` 工具函数生成 JSON Schema 描述：

```tsx
import { generateJsonSchema } from "./dynamic-form-core";

const fields = schema.fields;
const jsonSchema = generateJsonSchema(fields);

// 将 jsonSchema 提供给 AI，让 AI 按照这个规范输出
```

生成的 JSON Schema 示例：

```json
{
  "type": "object",
  "properties": {
    "username": {
      "type": "string",
      "description": "用户名"
    },
    "age": {
      "type": "number",
      "minimum": 0,
      "maximum": 120,
      "description": "年龄"
    },
    "status": {
      "type": "string",
      "enum": ["active", "inactive"],
      "description": "状态"
    }
  },
  "required": ["username"]
}
```

## 最佳实践

1. **表单验证**: 使用 Zod Schema 定义验证规则，确保类型安全
2. **初始值**: 合理设置 `defaultValue` 和 `initialValues`，避免非受控组件警告
3. **只读模式**: 用于数据展示时启用 `readonly`，提升用户体验
4. **实例方法**: 复杂交互场景下使用 `ref` 访问实例方法
5. **自定义渲染**: 对于特殊需求的字段，使用 `render` 函数自定义渲染逻辑

## 注意事项

- 确保字段的 `name` 在同一表单中唯一
- 选择类字段（select、radio）必须提供 `options` 属性
- 使用 `validateSchema` 时，字段名需要与 Schema 中定义的字段名一致
- 只读模式下，表单不会进行验证，因此可以隐藏操作按钮

## 故障排除

### 表单值未更新

检查是否正确设置了 `initialValues` 或字段的 `defaultValue`。

### 验证不生效

确保传入了正确的 `validateSchema`，并且字段名与验证 Schema 一致。

### 只读模式显示异常

对于 select 类型，确保 `options` 中包含当前值对应的选项。

## 相关链接

- [React Hook Form 文档](https://react-hook-form.com/)
- [Zod 文档](https://zod.dev/)
- [Ant Design Form](https://ant.design/components/form-cn/)
